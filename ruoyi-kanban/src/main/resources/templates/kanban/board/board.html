<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('任务看板')" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #0079bf;
            --bg-color: #f4f5f7;
            --card-bg: #ffffff;
            --text-main: #172b4d;
            --text-sub: #5e6c84;
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* 顶部导航 - 极简白风格 */
        .dashboard-header {
            background: #fff;
            padding: 16px 30px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-title i { color: var(--primary-color); }

        /* 现代搜索框 */
        .search-wrapper { position: relative; }
        .search-input {
            border: 2px solid transparent;
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 10px 15px 10px 40px;
            width: 260px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            background-color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 121, 191, 0.15);
            width: 320px;
            outline: none;
        }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #7a869a;
        }

        /* 3D质感按钮 */
        .btn-create {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 0 #005a8e; /* 3D底边 */
            transition: all 0.1s;
            text-decoration: none !important;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-create:hover { background-color: #026aa7; color: #fff; transform: translateY(-1px); box-shadow: 0 5px 0 #005a8e; }
        .btn-create:active { transform: translateY(4px); box-shadow: 0 0 0 #005a8e; }

        /* 网格布局 */
        .dashboard-content { padding: 30px; max-width: 1600px; margin: 0 auto; }
        .board-grid { display: flex; flex-wrap: wrap; margin: -15px; }
        .board-item-wrapper { width: 25%; padding: 15px; box-sizing: border-box; }

        @media (max-width: 1400px) { .board-item-wrapper { width: 33.33%; } }
        @media (max-width: 992px)  { .board-item-wrapper { width: 50%; } }
        @media (max-width: 576px)  { .board-item-wrapper { width: 100%; } }

        /* 卡片设计 */
        .board-card {
            background: var(--card-bg);
            border-radius: 12px;
            height: 160px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .board-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .card-header-bg {
            height: 45px;
            width: 100%;
            opacity: 0.15;
            position: absolute;
            top: 0; left: 0;
        }

        .card-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        .card-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 12px;
            position: relative;
        }
        .card-title::before {
            content: '';
            position: absolute;
            left: 0; top: 50%;
            transform: translateY(-50%);
            width: 6px; height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-sub);
            line-height: 1.6;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #8993a4;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        /* 悬浮操作按钮 */
        .card-actions {
            position: absolute;
            top: 15px; right: 15px;
            display: flex; gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }
        .board-card:hover .card-actions { opacity: 1; }

        .action-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: #fff;
            color: var(--text-sub);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        .action-btn:hover { color: var(--primary-color); transform: scale(1.1); }
        .action-btn.delete:hover { color: #e74c3c; background: #fff5f5; }

        .status-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-active { background-color: #e3fcef; color: #006644; }
        .status-closed { background-color: #ffebe6; color: #bf2600; }
    </style>
</head>
<body>

<div class="dashboard-header">
    <div class="header-title">
        <i class="fa fa-trello"></i> 看板中心
    </div>
    <div class="header-actions">
        <form id="searchForm" onsubmit="return false;">
            <div class="search-wrapper">
                <i class="fa fa-search search-icon"></i>
                <input type="text" class="search-input" name="boardName" placeholder="搜索看板..." onkeyup="loadBoardList()">
                <input type="hidden" name="status" value="">
            </div>
        </form>

        <button class="btn-create" onclick="openBoardModal()">
            <i class="fa fa-plus"></i> 新建看板
        </button>
    </div>
</div>

<div class="dashboard-content">
    <div class="board-grid" id="boardContainer">
    </div>
</div>

<th:block th:include="include :: footer" />

<script th:inline="javascript">
    var prefix = ctx + "kanban/board";
    // 权限标识
    var editFlag = [[${@permission.hasPermi('kanban:board:edit')}]];
    var removeFlag = [[${@permission.hasPermi('kanban:board:remove')}]];

    $(function() {
        loadBoardList();
    });

    // ============================================
    //  核心逻辑 - 去若依化交互
    // ============================================

    // 1. 加载数据
    function loadBoardList() {
        var formData = $("#searchForm").serialize();
        $.ajax({
            url: prefix + "/list",
            type: 'post',
            data: formData,
            dataType: "json",
            beforeSend: function() {
                // 自定义加载动画，不使用 $.modal.loading
                $("#boardContainer").html(
                    `<div style="width:100%; text-align:center; padding:100px 0; color:#999;">
                        <div class="fa fa-spinner fa-spin fa-3x" style="color:#dfe1e6; margin-bottom:15px;"></div>
                        <div>加载数据中...</div>
                     </div>`
                );
            },
            success: function(res) {
                if (res.code === 0) {
                    renderBoards(res.rows);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '加载失败',
                        text: res.msg,
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                }
            },
            error: function() {
                $("#boardContainer").html('<div style="width:100%; text-align:center; padding:50px;">加载出错，请刷新重试</div>');
            }
        });
    }

    // 2. 渲染 HTML (保持逻辑不变，升级样式)
    function renderBoards(rows) {
        if (!rows || rows.length === 0) {
            $("#boardContainer").html(
                `<div style="width:100%; text-align:center; padding:80px 0; color:#6b778c;">
                    <img src="/ruoyi/img/profile.jpg" style="width:80px; opacity:0.1; border-radius:50%; margin-bottom:20px; filter: grayscale(100%);">
                    <br>暂无看板，去创建一个吧
                 </div>`
            );
            return;
        }

        var html = rows.map(function(row) {
            var themeColor = row.themeColor || '#0079bf';
            var isClosed = row.status === '1';
            var statusBadge = isClosed
                ? `<span class="status-badge status-closed">已归档</span>`
                : `<span class="status-badge status-active">进行中</span>`;

            var dateStr = row.createTime ? row.createTime.substring(0, 10) : '-';

            // 操作按钮
            var actions = '';
            if (editFlag !== 'hidden') {
                actions += `<a class="action-btn" title="设置" onclick="openBoardModal('${row.boardId}')"><i class="fa fa-cog"></i></a>`;
            }
            if (removeFlag !== 'hidden') {
                actions += `<a class="action-btn delete" title="删除" onclick="deleteBoard('${row.boardId}')"><i class="fa fa-trash-o"></i></a>`;
            }

            return `
            <div class="board-item-wrapper">
                <div class="board-card" onclick="openKanbanView('${row.boardId}', '${row.boardName}')">
                    <div class="card-header-bg" style="background-color: ${themeColor}"></div>

                    <div class="card-actions" onclick="event.stopPropagation()">
                        ${actions}
                    </div>

                    <div class="card-content">
                        <div class="card-title" title="${row.boardName}" style="--title-color:${themeColor}">
                            <style>.card-title[title="${row.boardName}"]::before{background:${themeColor}}</style>
                            ${row.boardName}
                        </div>
                        <div class="card-desc">${row.intro || '暂无描述信息...'}</div>

                        <div class="card-footer">
                            ${statusBadge}
                            <span><i class="fa fa-clock-o"></i> ${dateStr}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');

        $("#boardContainer").html(html);
    }

    // 3. 弹窗交互 - 使用 Layer 深度定制 (替代 $.modal.open)
    function openBoardModal(boardId) {
        var url = prefix + "/add";
        var title = "创建新看板";
        if(boardId) {
            url = prefix + "/edit/" + boardId;
            title = "看板设置";
        }

        layer.open({
            type: 2,
            title: title,
            shadeClose: true,
            shade: 0.3,
            area: ['600px', '450px'],
            content: url,
            anim: 5, // 渐显动画
            btn: [], // 不使用默认按钮，完全交由子页面控制或自动保存
            success: function(layero, index){
                // 美化弹窗标题栏
                var header = layero.find('.layui-layer-title');
                header.css({
                    'background': '#fff',
                    'border-bottom': '1px solid #f0f0f0',
                    'font-weight': 'bold',
                    'color': '#172b4d'
                });
            },
            end: function() {
                loadBoardList(); // 弹窗关闭后自动刷新
            }
        });
    }

    // 4. 删除交互 - 使用 SweetAlert2 (替代 $.operate.remove)
    function deleteBoard(id) {
        Swal.fire({
            title: '确定要删除吗?',
            text: "删除看板将无法找回！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '是的，删除它!',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                // 手动执行 AJAX 删除
                $.ajax({
                    url: prefix + "/remove",
                    type: "post",
                    data: { "ids": id },
                    success: function(res) {
                        if (res.code === 0) {
                            Swal.fire(
                                '已删除!',
                                '该看板已被移除。',
                                'success'
                            );
                            loadBoardList();
                        } else {
                            Swal.fire('错误', res.msg, 'error');
                        }
                    }
                });
            }
        });
    }

    // 跳转详情 (保持若依Tab机制，因为这是框架核心体验)
    function openKanbanView(boardId, boardName) {
        var url = ctx + 'kanban/view/' + boardId;
        createMenuItem(url, boardName);
    }

    // 供子窗口调用的刷新
    window.refreshGrid = function() { loadBoardList(); }
</script>
</body>
</html>