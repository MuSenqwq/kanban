<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.w3.org/1999/xhtml">
<head>
  <th:block th:include="include :: header('任务看板')" />
  <style>
    body { background-color: #f4f5f7; overflow: hidden; }

    .board-header {
      height: 50px; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
      padding: 0 20px; display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .board-title { font-size: 18px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .header-tools { display: flex; gap: 10px; }
    .btn-tool {
      background: rgba(255,255,255,0.2); border: none; color: #fff;
      padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 13px; transition: background 0.2s;
    }
    .btn-tool:hover { background: rgba(255,255,255,0.3); }
    .quick-search {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: #fff; padding: 5px 10px; border-radius: 3px; width: 150px; transition: width 0.2s;
    }
    .quick-search:focus { width: 220px; background: #fff; color: #333; outline: none; }

    .kanban-board-wrapper {
      display: flex; overflow-x: auto; overflow-y: hidden;
      height: calc(100vh - 50px); padding: 15px; align-items: flex-start; white-space: nowrap;
    }

    .kanban-list {
      background-color: #ebecf0; width: 280px; min-width: 280px; margin-right: 15px;
      border-radius: 6px; display: flex; flex-direction: column; max-height: 100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .list-header {
      padding: 12px 15px; font-weight: 600; color: #172b4d;
      display: flex; justify-content: space-between; align-items: center;
    }
    .list-count { background: #dfe1e6; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

    .list-cards { flex: 1; overflow-y: auto; padding: 0 8px 8px; min-height: 10px; scrollbar-width: thin; }

    /* 卡片样式核心 */
    .kanban-card {
      background-color: #fff; padding: 10px; border-radius: 4px; margin-bottom: 8px;
      box-shadow: 0 1px 2px rgba(9,30,66,.25); cursor: pointer; position: relative;
      border-left: 4px solid transparent; transition: transform 0.1s;
    }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(9,30,66,.25); }

    .kanban-card.p-0 { border-left-color: #ff5252; }
    .kanban-card.p-1 { border-left-color: #ff9800; }
    .kanban-card.p-2 { border-left-color: #2196f3; }
    .kanban-card.p-3 { border-left-color: #9e9e9e; }

    .kanban-card.is-overdue { background-color: #fff5f5; border: 1px solid #ffdede; border-left: 4px solid #ff5252; }
    .overdue-badge { color: #c92a2a; font-size: 10px; font-weight: bold; display: block; margin-bottom: 4px; }

    .card-title { font-size: 14px; color: #172b4d; margin-bottom: 6px; white-space: normal; line-height: 1.4; }

    .progress-mini { height: 6px; background-color: #e9ecef; border-radius: 3px; margin: 8px 0; overflow: hidden; }
    .progress-bar-mini { height: 100%; background-color: #2196f3; border-radius: 3px; }
    .progress-100 { background-color: #4caf50; }

    .card-meta { display: flex; justify-content: space-between; font-size: 11px; color: #5e6c84; align-items: center; }

    .list-footer { padding: 8px; margin: 0 4px 4px; cursor: pointer; color: #5e6c84; border-radius: 4px; }
    .list-footer:hover { background: rgba(9,30,66,.08); color: #172b4d; }

    .chart-container { display: flex; padding: 20px; }
    .chart-box { width: 50%; height: 350px; }
    .stat-cards { display: flex; justify-content: space-around; margin-bottom: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .stat-item { text-align: center; }
    .stat-num { font-size: 24px; font-weight: bold; color: #0079bf; }
    .stat-desc { font-size: 12px; color: #666; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="gray-bg">

<div class="kanban-wrapper-bg" th:style="'background-color: ' + (${board.themeColor} != null ? ${board.themeColor} : '#0079bf')">

  <div class="board-header">
    <div class="board-title">
      <i class="fa fa-columns"></i> <span th:text="${board.boardName}">看板名称</span>
    </div>
    <div class="header-tools">
      <input type="text" id="filterInput" class="quick-search" placeholder="筛选任务..." onkeyup="filterCards()">
      <button class="btn-tool" onclick="openInviteMember()" shiro:hasRole="admin">
        <i class="fa fa-user-plus"></i> 邀请成员
      </button><button class="btn-tool" onclick="openStats()"><i class="fa fa-pie-chart"></i> 数据分析</button>
      <button class="btn-tool" onclick="refreshBoard()"><i class="fa fa-refresh"></i></button>
    </div>
  </div>

  <div class="kanban-board-wrapper">
    <div class="kanban-list" th:each="list : ${lists}" th:data-list-id="${list.listId}">
      <div class="list-header">
        <span th:text="${list.listName}">列表名称</span>
        <div>
          <span class="list-count" th:text="${list.cards != null ? list.cards.size() : 0}">0</span>
          <i class="fa fa-trash-o" style="cursor:pointer;margin-left:5px;color:#6b778c;" th:onclick="'deleteList(\'' + ${list.listId} + '\')'"></i>
        </div>
      </div>

      <div class="list-cards sortable-area" th:data-list-id="${list.listId}">

        <div class="kanban-card" th:each="card : ${list.cards}"
             th:data-card-id="${card.cardId}"
             th:classappend="'p-' + ${card.priority} + (${card.deadline != null && card.deadline.before(#dates.createNow()) && card.status != '1'} ? ' is-overdue' : '')"
             th:onclick="'editCard(\'' + ${card.cardId} + '\')'">

          <div th:if="${card.isExcellent == 'Y'}" style="position:absolute; right:8px; top:8px; color:#f1c40f; font-size:14px;" title="优秀任务">
            <i class="fa fa-trophy"></i>
          </div>

          <span class="overdue-badge" th:if="${card.deadline != null && card.deadline.before(#dates.createNow()) && card.status != '1'}">
                <i class="fa fa-exclamation-circle"></i> 已超期
            </span>

          <div class="card-title" th:text="${card.cardTitle}">任务标题</div>

          <div class="progress-mini" th:if="${card.progress != null && card.status != '1'}">
            <div class="progress-bar-mini"
                 th:style="'width:' + ${card.progress} + '%'"
                 th:classappend="${card.progress == 100} ? 'progress-100' : ''"></div>
          </div>

          <div class="card-meta">
                <span th:if="${card.executorId != null}" style="display: flex; align-items: center;" title="执行人">
                    <i class="fa fa-user-circle-o" style="margin-right:4px;"></i>
                    <span th:text="${card.executorId}"></span>
                </span>
            <span th:if="${card.executorId == null}" style="color: #ccc;">
                    <i class="fa fa-question-circle-o"></i> 待认领
                </span>

            <div style="text-align: right;">
                    <span th:if="${card.status == '1' && card.finishTime != null}" style="color: #27c24c; font-weight: bold;">
                        <i class="fa fa-check"></i> <span th:text="${#dates.format(card.finishTime, 'MM-dd')}"></span>
                    </span>
              <span th:if="${card.status != '1' && card.deadline != null}" th:title="'截止: ' + ${#dates.format(card.deadline, 'yyyy-MM-dd')}">
                        <i class="fa fa-clock-o"></i> <span th:text="${#dates.format(card.deadline, 'MM-dd')}"></span>
                    </span>
            </div>
          </div>
        </div>

      </div>

      <div class="list-footer" onclick="openAddCard(this)" th:data-list-id="${list.listId}">
        <i class="fa fa-plus"></i> 添加卡片
      </div>
    </div>

    <div class="kanban-list" style="background:rgba(0,0,0,0.1); color:#fff; min-width:280px; cursor:pointer; display:flex; align-items:center; justify-content:center; height:50px;" onclick="addList()">
      <i class="fa fa-plus"></i> 新建列表
    </div>
  </div>
</div>

<div id="statsModal" style="display:none; padding:15px;">
  <div class="stat-cards">
    <div class="stat-item"><div class="stat-num" id="s-total">0</div><div class="stat-desc">总任务</div></div>
    <div class="stat-item"><div class="stat-num" id="s-done" style="color:#4caf50;">0</div><div class="stat-desc">已完成</div></div>
    <div class="stat-item"><div class="stat-num" id="s-rate">0%</div><div class="stat-desc">完成率</div></div>
  </div>
  <div class="chart-container">
    <div id="pieChart" class="chart-box"></div>
    <div id="barChart" class="chart-box"></div>
  </div>
</div>

<th:block th:include="include :: footer" />
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script th:inline="javascript">
  var cardPrefix = ctx + "kanban/card";
  // [修复] 修正了之前错误的路径前缀
  var listPrefix = ctx + "kanban/list";
  var currentBoardId = [[${boardId}]];
  var autoRefreshTimer = null;

  $(function() {
    initDrag();
    // [新增] 页面加载完成后启动自动刷新
    startAutoRefresh();
  });

  window.refreshBoard = function() { window.location.reload(); }

  // [新增] 自动刷新功能：每10秒检查一次
  function startAutoRefresh() {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(function() {
      // 静默检查/保留扩展点
    }, 10000);
  }

  function initDrag() {
    var containers = document.querySelectorAll('.sortable-area');
    containers.forEach(function(container) {
      new Sortable(container, {
        group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', delay: 0,
        // 拖拽开始时暂停刷新
        onStart: function() {
          if(autoRefreshTimer) clearInterval(autoRefreshTimer);
        },
        onEnd: function (evt) {
          var itemEl = evt.item;

          var toListId = evt.to.getAttribute('data-list-id');
          var fromListId = evt.from.getAttribute('data-list-id');

          // 目标列排序
          var toOrderIds = Array.from(evt.to.children).map(function(card) {
            return card.getAttribute('data-card-id');
          }).join(',');

          // 来源列排序（跨列时才有意义；同列拖拽也传一份，后端会自动处理）
          var fromOrderIds = Array.from(evt.from.children).map(function(card) {
            return card.getAttribute('data-card-id');
          }).join(',');

          updateListCount(evt.to);
          if (evt.to !== evt.from) updateListCount(evt.from);

          $.ajax({
            url: cardPrefix + "/changeOrder",
            type: "post",
            dataType: "json",
            data: {
              "cardId": itemEl.getAttribute('data-card-id'),
              "listId": toListId,
              "sortOrder": toOrderIds,
              "fromListId": fromListId,
              "fromSortOrder": fromOrderIds
            },
            success: function(res) {
              if (res.code !== 0) {
                $.modal.msgError(res.msg);
                refreshBoard();
              }
              // 操作结束后重启刷新
              startAutoRefresh();
            },
            error: function() {
              $.modal.msgError("拖拽保存失败");
              refreshBoard();
              startAutoRefresh();
            }
          })
        }
      });
    });
  }

  function updateListCount(container) {
    var count = container.children.length;
    var header = container.previousElementSibling;
    if (header) header.querySelector('.list-count').innerText = count;
  }

  function filterCards() {
    var filter = $("#filterInput").val().toLowerCase();
    $(".kanban-card").each(function() {
      var title = $(this).find(".card-title").text().toLowerCase();
      $(this).toggle(title.indexOf(filter) > -1);
    });
  }

  // ✅ 修复：数据分析真正渲染图表，并改为请求 /kanban/view/stats/{boardId}
  function openStats() {
    // 打开弹窗时暂停刷新
    if(autoRefreshTimer) clearInterval(autoRefreshTimer);

    layer.open({
      type: 1,
      title: '看板数据驾驶舱',
      area: ['900px', '550px'],
      content: $('#statsModal'),
      success: function() {
        var pieDom = document.getElementById('pieChart');
        var barDom = document.getElementById('barChart');

        // 避免重复 init
        var pieOld = echarts.getInstanceByDom(pieDom);
        if (pieOld) { pieOld.dispose(); }
        var barOld = echarts.getInstanceByDom(barDom);
        if (barOld) { barOld.dispose(); }

        var pieChart = echarts.init(pieDom);
        var barChart = echarts.init(barDom);

        // 1) 拉取看板统计（用于数字 + 图表）
        $.get(ctx + "kanban/view/stats/" + currentBoardId, function(res) {
          if(res.code !== 0) {
            $.modal.msgError(res.msg || "获取看板统计失败");
            return;
          }

          var d = res.data || {};
          var total = d.total || 0;
          var done = d.done || 0;
          var rate = total > 0 ? Math.round((done / total) * 100) : 0;

          $("#s-total").text(total);
          $("#s-done").text(done);
          $("#s-rate").text(rate + "%");

          // 优先级饼图
          var priName = {"0":"紧急","1":"高","2":"中","3":"低"};
          var priStats = d.priorityStats || {};
          var pieData = [];
          Object.keys(priName).forEach(function(k){
            pieData.push({ name: priName[k], value: priStats[k] ? Number(priStats[k]) : 0 });
          });

          pieChart.setOption({
            tooltip: { trigger: 'item' },
            legend: { bottom: 0 },
            series: [{
              name: '优先级',
              type: 'pie',
              radius: ['35%', '65%'],
              center: ['50%', '45%'],
              data: pieData
            }]
          }, true);

          // 各列任务数量柱图
          var names = d.listNames || [];
          var counts = d.listCounts || [];
          barChart.setOption({
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: names, axisLabel: { interval: 0, rotate: 20 } },
            yAxis: { type: 'value' },
            series: [{ name: '任务数', type: 'bar', data: counts }]
          }, true);

          // 弹层打开后 resize 一次，避免宽高计算问题
          setTimeout(function(){
            pieChart.resize();
            barChart.resize();
          }, 80);
        });

        // 2) 仍然保留“未读消息提醒”（不影响图表）
        $.get(ctx + "kanban/main/stats", function(res) {
          if(res.code === 0 && res.data && res.data.unreadMsg > 0) {
            layer.confirm('您有 ' + res.data.unreadMsg + ' 条未读消息，是否前往查看？', {
              icon: 3,
              title:'新消息提醒',
              btn: ['去查看', '稍后']
            }, function(index){
              layer.close(index);
              window.location.href = ctx + "system/message";
            });
          }
        });

        // 窗口变化时同步 resize
        $(window).off("resize.kanbanStats").on("resize.kanbanStats", function(){
          pieChart.resize();
          barChart.resize();
        });
      },
      end: function() {
        $(window).off("resize.kanbanStats");
        startAutoRefresh();
      }
    });
  }

  function openAddCard(el) {
    var listId = el.getAttribute('data-list-id');
    $.modal.open("添加卡片", cardPrefix + "/add?listId=" + listId + "&boardId=" + currentBoardId, 800, 600, function() {
      refreshBoard();
    });
  }

  function editCard(id) {
    $.modal.open("任务详情", cardPrefix + "/edit/" + id, 800, 600, function() {
      refreshBoard();
    });
  }

  function addList() {
    layer.prompt({title: '列表名称'}, function(val, index){
      layer.close(index);
      $.operate.save(listPrefix + "/add", {boardId: currentBoardId, listName: val, orderNum: 99}, function(){ refreshBoard(); });
    });
  }

  function deleteList(id) {
    $.modal.confirm("确定删除该列表吗？", function() {
      $.operate.post(listPrefix + "/remove", {ids: id}, function(res){ if(res.code==0) refreshBoard(); });
    });
  }

  function openInviteMember() {
    var url = ctx + "kanban/board/invite/" + currentBoardId;
    $.modal.open("邀请成员加入看板", url, 500, 400, function() {
      refreshBoard();
    });
  }
</script>
</body>
</html>
