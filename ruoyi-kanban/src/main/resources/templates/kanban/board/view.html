<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:include="include :: header('任务看板')" />
  <style>
    /* 看板容器：横向滚动 */
    .kanban-board-wrapper {
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      height: calc(100vh - 50px);
      padding: 20px;
      background-color: #0079bf; /* 经典的看板蓝 */
      align-items: flex-start;
      white-space: nowrap;
    }

    /* 单个任务列 */
    .kanban-list {
      background-color: #ebecf0;
      width: 280px;
      min-width: 280px; /* 固定宽度 */
      margin-right: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      max-height: 100%;
      white-space: normal;
    }

    /* 列标题 */
    .list-header {
      padding: 10px 15px;
      font-weight: bold;
      color: #172b4d;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }

    /* 卡片存放区域 (可拖拽区) */
    .list-cards {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 8px 8px;
      min-height: 20px;
    }

    /* 任务卡片 */
    .kanban-card {
      background-color: #fff;
      padding: 8px 10px;
      border-radius: 3px;
      margin-bottom: 8px;
      box-shadow: 0 1px 0 rgba(9,30,66,.25);
      cursor: grab;
      position: relative;
    }
    .kanban-card:hover {
      background-color: #f4f5f7;
    }

    /* 优先级标签 */
    .card-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      color: #fff;
      float: right;
      margin-bottom: 4px;
    }
    .priority-0 { background-color: #ff5252; }
    .priority-1 { background-color: #ff9800; }
    .priority-2 { background-color: #2196f3; }
    .priority-3 { background-color: #9e9e9e; }

    /* 底部操作栏 */
    .list-footer {
      padding: 10px;
      color: #5e6c84;
      cursor: pointer;
      border-radius: 0 0 5px 5px;
      text-align: left;
      padding-left: 15px;
    }
    .list-footer:hover {
      background-color: rgba(9,30,66,.08);
      color: #172b4d;
    }

    /* [新增] 新建列表按钮样式 */
    .add-list-wrapper {
      width: 280px;
      min-width: 280px;
      margin-right: 15px;
      background-color: rgba(0,0,0,0.1);
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
      padding: 12px 15px;
      transition: background 0.1s;
    }
    .add-list-wrapper:hover {
      background-color: rgba(0,0,0,0.2);
    }

    .sortable-ghost {
      background-color: rgba(9,30,66,.08);
      border: 2px dashed #dfe1e6;
    }
  </style>
</head>
<body class="gray-bg">

<div class="kanban-board-wrapper">
  <div class="kanban-list" th:each="list : ${lists}" th:data-list-id="${list.listId}">
    <div class="list-header">
      <span th:text="${list.listName}">列表名称</span>
      <span class="badge" th:text="${list.cards != null ? list.cards.size() : 0}">0</span>
    </div>

    <div class="list-cards sortable-area" th:data-list-id="${list.listId}">
      <div class="kanban-card" th:each="card : ${list.cards}" th:data-card-id="${card.cardId}">
                    <span class="card-badge"
                          th:if="${card.priority != null}"
                          th:classappend="'priority-' + ${card.priority}"
                          th:text="${@dict.getLabel('kb_card_priority', card.priority)}">
                    </span>
        <div style="font-weight: 500; color: #172b4d; clear: both;" th:text="${card.cardTitle}">任务标题</div>
        <div style="margin-top: 5px; font-size: 11px; color: #5e6c84;" th:if="${card.deadline != null}">
          <i class="fa fa-clock-o"></i>
          <span th:text="${#dates.format(card.deadline, 'MM-dd')}"></span>
        </div>
      </div>
    </div>

    <div class="list-footer" onclick="openAddCard(this)" th:data-list-id="${list.listId}">
      <i class="fa fa-plus"></i> 添加卡片
    </div>
  </div>

  <div class="add-list-wrapper" onclick="addList()">
    <i class="fa fa-plus"></i> 新建列表
  </div>
</div>

<th:block th:include="include :: footer" />
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script th:inline="javascript">
  var cardPrefix = ctx + "kanban/card";
  // 注意：这里用的是你上传的 KbListController 的路径前缀
  var listPrefix = ctx + "ruoyi-kanban/list";
  var currentBoardId = [[${boardId}]];

  $(function() {
    initDragAndDrop();
  });

  function initDragAndDrop() {
    var containers = document.querySelectorAll('.sortable-area');
    containers.forEach(function(container) {
      new Sortable(container, {
        group: 'kanban',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
          var itemEl = evt.item;
          var toList = evt.to;
          var cardId = itemEl.getAttribute('data-card-id');
          var toListId = toList.getAttribute('data-list-id');
          var newOrderIds = Array.from(toList.children).map(function(card) {
            return card.getAttribute('data-card-id');
          }).join(',');

          $.ajax({
            url: cardPrefix + "/changeOrder",
            type: "post",
            dataType: "json",
            data: {
              "cardId": cardId,
              "listId": toListId,
              "sortOrder": newOrderIds
            },
            success: function(result) {
              if (result.code != 0) {
                $.modal.msgError(result.msg);
              }
            }
          })
        }
      });
    });
  }

  // 打开添加卡片弹窗
  function openAddCard(element) {
    var listId = element.getAttribute('data-list-id');
    var url = cardPrefix + "/add?listId=" + listId + "&boardId=" + currentBoardId;
    $.modal.open("添加卡片", url);
  }

  // [新增] 快速添加列表的功能
  function addList() {
    layer.prompt({title: '请输入列表名称', formType: 0}, function(text, index){
      layer.close(index);
      $.operate.save(listPrefix + "/add", {
        "boardId": currentBoardId,
        "listName": text,
        "listStatus": "0",
        "orderNum": 99
      }, function(){
        location.reload(); // 成功后刷新页面
      });
    });
  }
</script>
</body>
</html>