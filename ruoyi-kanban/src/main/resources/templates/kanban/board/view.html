<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:include="include :: header('任务看板')" />
  <style>
    body { background-color: #f4f5f7; overflow: hidden; }

    /* 1. 顶部半透明磨砂导航栏 */
    .board-header {
      height: 50px;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
    }
    .board-title { font-size: 18px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

    /* 工具栏按钮组 */
    .header-tools { display: flex; gap: 10px; }
    .btn-tool {
      background: rgba(255,255,255,0.2); border: none; color: #fff;
      padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 13px;
      transition: background 0.2s;
    }
    .btn-tool:hover { background: rgba(255,255,255,0.3); }

    /* 搜索框 */
    .quick-search {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: #fff; padding: 5px 10px; border-radius: 3px; width: 150px;
      transition: width 0.2s;
    }
    .quick-search:focus { width: 220px; background: #fff; color: #333; outline: none; }
    .quick-search::placeholder { color: rgba(255,255,255,0.8); }

    /* 2. 看板主体容器 */
    .kanban-board-wrapper {
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      height: calc(100vh - 50px);
      padding: 15px;
      align-items: flex-start;
      white-space: nowrap;
    }

    /* 列样式 */
    .kanban-list {
      background-color: #ebecf0;
      width: 280px; min-width: 280px;
      margin-right: 15px;
      border-radius: 6px;
      display: flex; flex-direction: column;
      max-height: 100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .list-header {
      padding: 12px 15px; font-weight: 600; color: #172b4d;
      display: flex; justify-content: space-between; align-items: center;
    }
    .list-count { background: #dfe1e6; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

    /* 卡片区域 */
    .list-cards {
      flex: 1; overflow-y: auto; padding: 0 8px 8px;
      min-height: 10px;
      scrollbar-width: thin;
    }

    /* --- 核心：卡片样式升级 --- */
    .kanban-card {
      background-color: #fff;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      box-shadow: 0 1px 2px rgba(9,30,66,.25);
      cursor: pointer;
      position: relative;
      border-left: 4px solid transparent; /* 优先级色条预留 */
      transition: transform 0.1s;
    }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(9,30,66,.25); }

    /* 优先级色条 */
    .kanban-card.p-0 { border-left-color: #ff5252; } /* 紧急-红 */
    .kanban-card.p-1 { border-left-color: #ff9800; } /* 高-橙 */
    .kanban-card.p-2 { border-left-color: #2196f3; } /* 中-蓝 */
    .kanban-card.p-3 { border-left-color: #9e9e9e; } /* 低-灰 */

    /* 超期预警样式 */
    .kanban-card.is-overdue { background-color: #fff5f5; border: 1px solid #ffdede; border-left: 4px solid #ff5252; }
    .overdue-badge {
      color: #c92a2a; font-size: 10px; font-weight: bold;
      display: block; margin-bottom: 4px;
    }

    .card-title { font-size: 14px; color: #172b4d; margin-bottom: 6px; white-space: normal; line-height: 1.4; }

    /* 进度条 */
    .progress-mini {
      height: 6px; background-color: #e9ecef; border-radius: 3px; margin: 8px 0; overflow: hidden;
    }
    .progress-bar-mini {
      height: 100%; background-color: #2196f3; border-radius: 3px;
      transition: width 0.3s;
    }
    /* 进度颜色变化 */
    .progress-100 { background-color: #4caf50; } /* 完成变绿 */

    .card-meta { display: flex; justify-content: space-between; font-size: 11px; color: #5e6c84; }

    .list-footer {
      padding: 8px; margin: 0 4px 4px; cursor: pointer; color: #5e6c84; border-radius: 4px;
    }
    .list-footer:hover { background: rgba(9,30,66,.08); color: #172b4d; }

    /* 统计弹窗样式 */
    .chart-container { display: flex; padding: 20px; }
    .chart-box { width: 50%; height: 350px; }
    .stat-cards { display: flex; justify-content: space-around; margin-bottom: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .stat-item { text-align: center; }
    .stat-num { font-size: 24px; font-weight: bold; color: #0079bf; }
    .stat-desc { font-size: 12px; color: #666; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="gray-bg">

<div class="kanban-wrapper-bg" th:style="'background-color: ' + (${board.themeColor} != null ? ${board.themeColor} : '#0079bf')">

  <div class="board-header">
    <div class="board-title">
      <i class="fa fa-columns"></i> <span th:text="${board.boardName}">看板名称</span>
    </div>
    <div class="header-tools">
      <input type="text" id="filterInput" class="quick-search" placeholder="筛选任务..." onkeyup="filterCards()">

      <button class="btn-tool" onclick="openStats()">
        <i class="fa fa-pie-chart"></i> 数据分析
      </button>
      <button class="btn-tool" onclick="refreshBoard()">
        <i class="fa fa-refresh"></i>
      </button>
    </div>
  </div>

  <div class="kanban-board-wrapper">

    <div class="kanban-list" th:each="list : ${lists}" th:data-list-id="${list.listId}">
      <div class="list-header">
        <span th:text="${list.listName}">列表名称</span>
        <div>
          <span class="list-count" th:text="${list.cards != null ? list.cards.size() : 0}">0</span>
          <i class="fa fa-trash-o" style="cursor:pointer;margin-left:5px;color:#6b778c;" th:onclick="'deleteList(\'' + ${list.listId} + '\')'"></i>
        </div>
      </div>

      <div class="list-cards sortable-area" th:data-list-id="${list.listId}">

        <div class="kanban-card" th:each="card : ${list.cards}"
             th:data-card-id="${card.cardId}"
             th:classappend="'p-' + ${card.priority} + (${card.deadline != null && card.deadline.before(#dates.createNow()) && card.progress < 100} ? ' is-overdue' : '')"
             th:onclick="'editCard(\'' + ${card.cardId} + '\')'">

            <span class="overdue-badge" th:if="${card.deadline != null && card.deadline.before(#dates.createNow()) && card.progress < 100}">
                <i class="fa fa-exclamation-circle"></i> 已超期
            </span>

          <div class="card-title" th:text="${card.cardTitle}">任务标题</div>

          <div class="progress-mini" th:if="${card.progress != null}">
            <div class="progress-bar-mini"
                 th:style="'width:' + ${card.progress} + '%'"
                 th:classappend="${card.progress == 100} ? 'progress-100' : ''"></div>
          </div>

          <div class="card-meta">
                <span th:if="${card.deadline != null}">
                    <i class="fa fa-calendar"></i> <span th:text="${#dates.format(card.deadline, 'MM-dd')}"></span>
                </span>
            <span th:if="${card.progress != null}" th:text="${card.progress} + '%'">0%</span>
          </div>
        </div>

      </div>

      <div class="list-footer" onclick="openAddCard(this)" th:data-list-id="${list.listId}">
        <i class="fa fa-plus"></i> 添加卡片
      </div>
    </div>

    <div class="kanban-list" style="background:rgba(0,0,0,0.1); color:#fff; min-width:280px; cursor:pointer; display:flex; align-items:center; justify-content:center; height:50px;" onclick="addList()">
      <i class="fa fa-plus"></i> 新建列表
    </div>
  </div>
</div>

<div id="statsModal" style="display:none; padding:15px;">
  <div class="stat-cards">
    <div class="stat-item">
      <div class="stat-num" id="s-total">0</div><div class="stat-desc">总任务</div>
    </div>
    <div class="stat-item">
      <div class="stat-num" id="s-done" style="color:#4caf50;">0</div><div class="stat-desc">已完成</div>
    </div>
    <div class="stat-item">
      <div class="stat-num" id="s-rate">0%</div><div class="stat-desc">完成率</div>
    </div>
  </div>
  <div class="chart-container">
    <div id="pieChart" class="chart-box"></div>
    <div id="barChart" class="chart-box"></div>
  </div>
</div>

<th:block th:include="include :: footer" />
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script th:inline="javascript">
  var cardPrefix = ctx + "kanban/card";
  var listPrefix = ctx + "ruoyi-kanban/list";
  var currentBoardId = [[${boardId}]];

  $(function() { initDrag(); });

  function initDrag() {
    var containers = document.querySelectorAll('.sortable-area');
    containers.forEach(function(container) {
      new Sortable(container, {
        group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', delay: 0,
        onEnd: function (evt) {
          var itemEl = evt.item;
          var toList = evt.to;
          var cardId = itemEl.getAttribute('data-card-id');
          var toListId = toList.getAttribute('data-list-id');
          var newOrderIds = Array.from(toList.children).map(function(card) { return card.getAttribute('data-card-id'); }).join(',');

          $.ajax({
            url: cardPrefix + "/changeOrder", type: "post", dataType: "json",
            data: { "cardId": cardId, "listId": toListId, "sortOrder": newOrderIds }
          })
        }
      });
    });
  }

  // 纯前端筛选
  function filterCards() {
    var filter = $("#filterInput").val().toLowerCase();
    $(".kanban-card").each(function() {
      var title = $(this).find(".card-title").text().toLowerCase();
      $(this).toggle(title.indexOf(filter) > -1);
    });
  }

  // 打开数据分析
  function openStats() {
    layer.open({
      type: 1, title: '看板数据驾驶舱', area: ['900px', '550px'], content: $('#statsModal'),
      success: function() {
        $.get(ctx + "kanban/view/stats/" + currentBoardId, function(res) {
          if(res.code === 0) renderCharts(res.data);
        });
      }
    });
  }

  function renderCharts(data) {
    $("#s-total").text(data.total);
    $("#s-done").text(data.done);
    var rate = data.total > 0 ? Math.round((data.done/data.total)*100) : 0;
    $("#s-rate").text(rate + "%");

    // 饼图：任务分布
    var pieData = [];
    for(var i=0; i<data.listNames.length; i++) pieData.push({value: data.listCounts[i], name: data.listNames[i]});

    var pie = echarts.init(document.getElementById('pieChart'));
    pie.setOption({
      title: { text: '任务分布', left: 'center' },
      tooltip: { trigger: 'item' },
      series: [{ type: 'pie', radius: ['40%', '70%'], data: pieData }]
    });

    // 柱状图：优先级
    var bar = echarts.init(document.getElementById('barChart'));
    var pMap = data.priorityStats;
    bar.setOption({
      title: { text: '优先级统计', left: 'center' },
      tooltip: { trigger: 'axis' },
      xAxis: { type: 'category', data: ['紧急', '高', '中', '低'] },
      yAxis: { type: 'value' },
      series: [{
        type: 'bar', data: [pMap['0']||0, pMap['1']||0, pMap['2']||0, pMap['3']||0],
        itemStyle: { color: function(p) { return ['#ff5252','#ff9800','#2196f3','#9e9e9e'][p.dataIndex]; } }
      }]
    });
  }

  function openAddCard(el) {
    var listId = el.getAttribute('data-list-id');
    $.modal.open("添加卡片", cardPrefix + "/add?listId=" + listId + "&boardId=" + currentBoardId, 800, 600);
  }
  function editCard(id) {
    $.modal.open("修改卡片", cardPrefix + "/edit/" + id, 800, 600);
  }
  function addList() {
    layer.prompt({title: '列表名称'}, function(val, index){
      layer.close(index);
      $.operate.save(listPrefix + "/add", {boardId: currentBoardId, listName: val, orderNum: 99}, function(){ location.reload(); });
    });
  }
  function deleteList(id) {
    $.modal.confirm("确定删除该列表吗？", function() {
      $.operate.post(listPrefix + "/remove", {ids: id}, function(res){ if(res.code==0) location.reload(); });
    });
  }
  function refreshBoard() { location.reload(); }
</script>
</body>
</html>