<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('编辑任务')" />
    <th:block th:include="include :: datetimepicker-css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f4f5f7; padding: 20px; font-family: sans-serif; }
        .card-wrapper { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .header-actions { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .card-title-input {
            font-size: 18px; font-weight: 700; color: #172b4d; border: 2px solid transparent;
            width: 80%; padding: 5px; border-radius: 4px; transition: 0.2s; background: transparent;
        }
        .card-title-input:focus { background: #fff; border-color: #0079bf; outline: none; }

        .btn-trash { color: #6b778c; cursor: pointer; padding: 5px 10px; font-size: 14px; }
        .btn-trash:hover { color: #bf2600; background: #ffebe6; border-radius: 4px; }

        .field-group { margin-bottom: 18px; }
        .field-label { font-size: 12px; font-weight: 600; color: #5e6c84; margin-bottom: 5px; text-transform: uppercase; }

        .modern-select, .modern-input { width: 100%; padding: 8px; border: 1px solid #dfe1e6; border-radius: 4px; background: #fafbfc; }

        /* 进度条滑块 */
        input[type=range] { width: 100%; margin: 10px 0; }

        .bottom-bar { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-ok { background: #0079bf; color: #fff; border: none; padding: 8px 24px; border-radius: 4px; cursor: pointer; }
        .btn-ok:hover { background: #026aa7; }
    </style>
</head>
<body>

<div class="card-wrapper">
    <form id="form-card-edit" th:object="${card}">
        <input name="cardId" th:field="*{cardId}" type="hidden">

        <div class="header-actions">
            <input type="text" name="cardTitle" th:field="*{cardTitle}" class="card-title-input" required>
            <span class="btn-trash" onclick="deleteCard()"><i class="fa fa-trash-o"></i> 删除</span>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 2;">
                <div class="field-group">
                    <div class="field-label">描述</div>
                    <!-- 核心修复：description改为cardContent，匹配实体类字段 -->
                    <textarea name="cardContent" class="modern-input" rows="8" th:field="*{cardContent}" placeholder="添加更详细的描述..."></textarea>
                </div>
            </div>

            <div style="flex: 1; background: #f9f9fa; padding: 15px; border-radius: 6px;">
                <div class="field-group">
                    <div class="field-label">状态</div>
                    <select name="status" class="modern-select" th:field="*{status}">
                        <option value="0">进行中</option>
                        <option value="1">已完成</option>
                    </select>
                </div>

                <div class="field-group">
                    <div class="field-label">优先级</div>
                    <select name="priority" class="modern-select" th:field="*{priority}">
                        <option value="0" style="color:red">紧急</option>
                        <option value="1" style="color:orange">高</option>
                        <option value="2" style="color:blue">中</option>
                        <option value="3" style="color:gray">低</option>
                    </select>
                </div>

                <div class="field-group">
                    <div class="field-label">截止日期</div>
                    <!-- 修复：增加空值判断，避免日期为null时报错 -->
                    <input type="text" class="modern-input time-input" name="deadline" th:value="${card.deadline != null ? #dates.format(card.deadline, 'yyyy-MM-dd') : ''}" readonly style="cursor:pointer">
                </div>

                <div class="field-group">
                    <div class="field-label">执行人</div>
                    <input type="text" name="executorId" class="modern-input" th:field="*{executorId}">
                </div>

                <div class="field-group">
                    <!-- 修复：进度为空时显示0% -->
                    <div class="field-label">进度: <span id="progVal" th:text="*{progress} ?: 0 + '%'"></span></div>
                    <input type="range" name="progress" min="0" max="100" step="5" th:field="*{progress}" oninput="$('#progVal').text(this.value + '%')">
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <button type="button" class="btn-ok" onclick="submitHandler()">保存所有更改</button>
        </div>
    </form>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: datetimepicker-js" />
<script>
    var prefix = ctx + "kanban/card";

    function submitHandler() {
        $.ajax({
            url: prefix + "/edit",
            type: "post",
            data: $('#form-card-edit').serialize(),
            success: function(res) {
                if(res.code === 0) {
                    Swal.fire({icon: 'success', title: '保存成功', toast: true, position: 'top', timer: 1000, showConfirmButton: false})
                        .then(() => {
                            parent.refreshBoard();
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                } else {
                    Swal.fire('错误', res.msg, 'error');
                }
            }
        });
    }

    function deleteCard() {
        Swal.fire({
            title: '删除任务?',
            text: "此操作不可撤销",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '删除'
        }).then((result) => {
            if (result.isConfirmed) {
                var id = $("input[name='cardId']").val();
                $.post(prefix + "/remove", {ids: id}, function(res){
                    if(res.code === 0) {
                        parent.refreshBoard();
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    }
                });
            }
        })
    }

    $(".time-input").datetimepicker({
        format: 'yyyy-mm-dd', autoclose: true, minView: 2, language: 'zh-CN'
    });
</script>
</body>
</html>