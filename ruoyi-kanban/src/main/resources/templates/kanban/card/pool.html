<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('任务池')" />
    <style>
        /* 卡片基础样式 */
        .task-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: all 0.3s;
            border: 1px solid #e7eaec;
            position: relative;
            overflow: hidden;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        /* 优先级角标 */
        .priority-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 10px;
            font-size: 12px;
            border-bottom-left-radius: 8px;
            color: #fff;
            font-weight: bold;
        }
        .priority-0 { background-color: #ed5565; } /* 紧急 - 红 */
        .priority-1 { background-color: #f8ac59; } /* 高 - 橙 */
        .priority-2 { background-color: #1ab394; } /* 普通 - 绿 */

        .card-body { padding: 20px; }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            height: 24px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .card-meta {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .card-meta i { width: 20px; text-align: center; margin-right: 5px; }
        .card-footer-btn {
            border-top: 1px solid #f0f0f0;
            padding: 10px 20px;
            background: #fbfbfb;
            text-align: right;
        }
        /* 用户选择样式 */
        .user-item {
            padding: 10px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            background: #fff;
        }
        .user-item:hover { background-color: #f5f5f5; }
        .user-item.active {
            background-color: #1ab394;
            border-color: #1ab394;
            color: #fff;
        }
        /* 分页器样式 */
        .custom-pagination { margin-top: 20px; text-align: center; }
        .loading-mask { text-align: center; padding: 50px; color: #999; }
    </style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="ibox float-e-margins mb10">
        <div class="ibox-content" style="padding: 15px 20px 5px 20px;">
            <form id="formId">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <input type="text" class="form-control" name="cardTitle" placeholder="输入任务标题搜索...">
                        </div>
                    </div>
                    <div class="col-sm-9 text-right">
                        <a class="btn btn-primary btn-rounded btn-sm" onclick="searchQuery()"><i class="fa fa-search"></i> 搜索</a>
                        <a class="btn btn-warning btn-rounded btn-sm" onclick="resetQuery()"><i class="fa fa-refresh"></i> 重置</a>
                        <!-- 修复：给新建按钮指定明确的新增路径 -->
                        <a class="btn btn-success btn-rounded btn-sm" onclick="addTask()" th:if="${isAdmin}">
                            <i class="fa fa-plus"></i> 新建任务
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row" id="cardContainer">
    </div>

    <div class="row">
        <div class="col-sm-12 custom-pagination">
            <button class="btn btn-default btn-sm" id="btnPrev" onclick="changePage(-1)" disabled><i class="fa fa-chevron-left"></i> 上一页</button>
            <span class="m-l-sm m-r-sm">第 <span id="currPage">1</span> 页 / 共 <span id="totalPage">0</span> 页</span>
            <button class="btn btn-default btn-sm" id="btnNext" onclick="changePage(1)" disabled>下一页 <i class="fa fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<div id="assignUserModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm" style="width:600px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">选择指派执行人</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalCardId" value="">
                <div id="userList" class="row" style="max-height:280px;overflow-y:auto;padding:10px;">
                    <div class="text-center text-muted">点击指派后自动加载可选择用户...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="doAssign()">确认指派</button>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: footer" />
<script th:inline="javascript">
    var prefix = ctx + "kanban/card";
    var isAdmin = [[${isAdmin}]];
    var currentPage = 1;
    var pageSize = 12; // 每页显示12个卡片
    var selectExecutorId = null;

    $(function() {
        loadData();
    });

    function searchQuery() {
        currentPage = 1;
        loadData();
    }

    function resetQuery() {
        $("#formId")[0].reset();
        searchQuery();
    }

    function changePage(delta) {
        currentPage += delta;
        loadData();
    }

    function loadData() {
        $("#cardContainer").html('<div class="col-sm-12 loading-mask"><i class="fa fa-spinner fa-spin fa-3x"></i><br>正在加载任务池...</div>');

        var data = $("#formId").serializeArray();
        data.push({name: "pageNum", value: currentPage});
        data.push({name: "pageSize", value: pageSize});

        $.post(prefix + "/pool/list", data, function(res) {
            if (res.code === 0) {
                renderCards(res.rows);
                updatePagination(res.total);
            } else {
                $.modal.msgError(res.msg);
            }
        });
    }

    function renderCards(rows) {
        var html = "";
        if (!rows || rows.length === 0) {
            $("#cardContainer").html('<div class="col-sm-12 text-center text-muted" style="padding:50px;">暂无待领取的任务</div>');
            return;
        }

        $.each(rows, function(i, card) {
            // 优先级处理
            var priorityClass = "priority-2";
            var priorityText = "普通";
            if(card.priority == '0') { priorityClass = "priority-0"; priorityText = "紧急"; }
            else if(card.priority == '1') { priorityClass = "priority-1"; priorityText = "高"; }

            // 时间处理
            var deadline = card.deadline ? card.deadline.substring(0, 10) : '无截止日期';
            var createTime = card.createTime ? card.createTime.substring(0, 10) : '-';

            // 按钮区
            var buttons = `<button class="btn btn-info btn-xs btn-outline" onclick="claimTask(${card.cardId})"><i class="fa fa-hand-paper-o"></i> 认领</button>`;
            if(isAdmin) {
                buttons += ` <button class="btn btn-primary btn-xs btn-outline m-l-xs" onclick="showAssignUserDialog(${card.cardId})"><i class="fa fa-user-plus"></i> 指派</button>`;
            }

            html += `
            <div class="col-sm-6 col-md-4 col-lg-3 animated fadeIn">
                <div class="task-card">
                    <div class="priority-badge ${priorityClass}">${priorityText}</div>
                    <div class="card-body">
                        <div class="card-title" title="${card.cardTitle}">${card.cardTitle}</div>
                        <div class="card-meta"><i class="fa fa-clock-o"></i> 创建：${createTime}</div>
                        <div class="card-meta"><i class="fa fa-flag-o"></i> 截止：${deadline}</div>
                        <div class="text-muted m-t-sm" style="font-size:12px;height:34px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">
                            ${card.cardContent || '暂无详情描述...'}
                        </div>
                    </div>
                    <div class="card-footer-btn">
                        ${buttons}
                    </div>
                </div>
            </div>
            `;
        });
        $("#cardContainer").html(html);
    }

    function updatePagination(total) {
        var totalPage = Math.ceil(total / pageSize);
        if(totalPage === 0) totalPage = 1;
        $("#currPage").text(currentPage);
        $("#totalPage").text(totalPage);
        $("#btnPrev").prop("disabled", currentPage <= 1);
        $("#btnNext").prop("disabled", currentPage >= totalPage);
    }

    /* --- 新增：新建任务的核心方法 --- */
    function addTask() {
        var url = prefix + '/add';
        var index = layer.open({
            type: 2,
            title: "新增任务",
            content: url,
            area: ['800px', '500px'],
            end: function() {
                currentPage = 1;
                loadData();
            }
        });
        $.modal.index = index;
    }
    /* --- 业务逻辑 --- */
    function claimTask(cardId) {
        $.modal.confirm("确定要认领这个任务吗？", function() {
            $.operate.post(prefix + "/claim", { "cardId": cardId }, function(res) {
                if (res.code === 0) {
                    $.modal.msgSuccess("认领成功！");
                    loadData();
                } else {
                    $.modal.msgError(res.msg);
                }
            });
        });
    }

    function showAssignUserDialog(cardId) {
        selectExecutorId = null;
        $("#modalCardId").val(cardId);
        $("#userList").html('<div class="text-center text-muted"><i class="fa fa-spinner fa-spin"></i> 加载中...</div>');

        $.get(prefix + "/assignUser?cardId=" + cardId, function(res) {
            if (res.code === 0 && res.data) {
                var html = "";
                if (res.data.length === 0) {
                    html = '<div class="text-center text-warning">暂无人员</div>';
                } else {
                    $.each(res.data, function(i, user) {
                        html += `
                        <div class="col-xs-6 col-sm-4" style="margin-bottom:8px;">
                            <div class="user-item" onclick="selectUser(this, ${user.userId})">
                                ${user.userName}
                            </div>
                        </div>`;
                    });
                }
                $("#userList").html(html);
            } else {
                $("#userList").html('<div class="text-danger">加载失败</div>');
            }
        });
        $("#assignUserModal").modal("show");
    }

    function selectUser(obj, userId) {
        $(".user-item").removeClass("active");
        $(obj).addClass("active");
        selectExecutorId = userId;
    }

    function doAssign() {
        var cardId = $("#modalCardId").val();
        if (!selectExecutorId) {
            $.modal.msgWarning("请选择人员");
            return;
        }
        $.operate.post(prefix + "/assign", { cardId: cardId, executorId: selectExecutorId }, function(res) {
            if (res.code === 0) {
                $.modal.msgSuccess("指派成功");
                $("#assignUserModal").modal("hide");
                loadData();
            } else {
                $.modal.msgError(res.msg);
            }
        });
    }
</script>
</body>
</html>