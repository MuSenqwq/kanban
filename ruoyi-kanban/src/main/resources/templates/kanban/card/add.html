<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('新建任务')" />
    <th:block th:include="include :: datetimepicker-css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 25px;
            color: #172b4d;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .card-form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-col {
            flex: 1;
            min-width: 280px;
        }

        .modern-label {
            font-weight: 600;
            font-size: 13px;
            color: #5e6c84;
            margin-bottom: 6px;
            display: block;
        }
        .modern-input {
            width: 100%;
            border: 1px solid #dfe1e6;
            background: #fafbfc;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        .modern-input:focus {
            background: #fff;
            border-color: #4c9aff;
            box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.2);
            outline: none;
        }

        /* 优先级选择美化 */
        .priority-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .priority-opt {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: #666;
            min-width: 60px;
        }
        .priority-opt:hover {
            background: #f4f5f7;
            transform: translateY(-1px);
        }
        .priority-opt input {
            display: none;
        }

        .priority-opt.p-0.active {
            background: #ffebe6;
            color: #de350b;
            border-color: #ffbdad;
            font-weight: bold;
        } /* 紧急 */
        .priority-opt.p-1.active {
            background: #fff7d6;
            color: #b65c02;
            border-color: #ffe380;
            font-weight: bold;
        } /* 高 */
        .priority-opt.p-2.active {
            background: #deebff;
            color: #0747a6;
            border-color: #b3d4ff;
            font-weight: bold;
        } /* 中 */
        .priority-opt.p-3.active {
            background: #eff2f5;
            color: #42526e;
            border-color: #dfe1e6;
            font-weight: bold;
        } /* 低 */

        .btn-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ebecf0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .btn-submit {
            background: linear-gradient(to bottom, #0052cc, #0747a6);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-submit:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }
        .btn-submit:active {
            transform: translateY(0);
        }

        /* 下拉框样式适配 */
        .form-select {
            height: 38px;
            appearance: none;
            -webkit-appearance: none;
            background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235e6c84' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 10px center;
            background-size: 16px;
            padding-right: 30px !important;
        }

        /* 必选标识 */
        .required-mark {
            color: #de350b;
            margin-left: 2px;
        }

        /* 禁用状态样式 */
        .modern-input:disabled {
            background: #f9f9f9;
            color: #999;
            cursor: not-allowed;
        }

        /* 错误提示样式 */
        .error-tip {
            color: #de350b;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
    </style>
</head>
<body>

<div class="card-form-container">
    <form id="form-card-add">
        <input type="hidden" name="boardId" th:value="${boardId}" th:if="${boardId != null}">
        <input type="hidden" name="listId" th:value="${listId}" th:if="${listId != null}">
        
        <div class="modern-group" style="margin-bottom: 20px;" th:if="${boardId == null && listId == null}">
            <label class="modern-label">
                所属看板
                <span class="required-mark">*</span>
            </label>
            <select name="boardId" class="modern-input form-select" id="boardSelect" required>
                <option value="">-- 请选择看板 --</option>
                <option th:each="board : ${boards}" th:value="${board.boardId}" th:text="${board.boardName}"></option>
            </select>
            <div class="error-tip" id="boardIdTip">请选择所属看板</div>
        </div>

        <!-- 任务池新增时显示：清单选择下拉框（空模板，JS动态加载） -->
        <div class="modern-group" style="margin-bottom: 20px;" th:if="${boardId == null && listId == null}">
            <label class="modern-label">
                所属清单
                <span class="required-mark">*</span>
            </label>
            <select name="listId" class="modern-input form-select" id="listSelect" required>
                <option value="">-- 请先选择看板 --</option>
            </select>
            <div class="error-tip" id="listIdTip">请选择所属清单</div>
        </div>

        <!-- 任务标题 -->
        <div class="modern-group" style="margin-bottom: 20px;">
            <label class="modern-label">
                任务标题
                <span class="required-mark">*</span>
            </label>
            <input type="text" name="cardTitle" class="modern-input" placeholder="输入任务核心内容（如：完成用户需求调研）..." required style="font-size: 16px; font-weight: 500;">
            <div class="error-tip" id="cardTitleTip">请输入任务标题（最多100个字符）</div>
        </div>

        <!-- 优先级 + 截止时间 -->
        <div class="form-row">
            <div class="form-col">
                <label class="modern-label">
                    <i class="fa fa-flag"></i> 优先级
                </label>
                <div class="priority-group">
                    <label class="priority-opt p-0" onclick="setPri(this)">
                        <input type="radio" name="priority" value="0"> 紧急
                    </label>
                    <label class="priority-opt p-1" onclick="setPri(this)">
                        <input type="radio" name="priority" value="1"> 高
                    </label>
                    <label class="priority-opt p-2 active" onclick="setPri(this)">
                        <input type="radio" name="priority" value="2" checked> 中
                    </label>
                    <label class="priority-opt p-3" onclick="setPri(this)">
                        <input type="radio" name="priority" value="3"> 低
                    </label>
                </div>
            </div>
            <div class="form-col">
                <label class="modern-label">
                    <i class="fa fa-calendar"></i> 截止时间
                </label>
                <div class="input-group date">
                    <input name="deadline" class="modern-input time-input" placeholder="选择任务截止日期" type="text" readonly style="background-color:#fff; cursor:pointer;">
                    <span class="input-group-addon" style="display:none;"><i class="fa fa-calendar"></i></span>
                </div>
            </div>
        </div>

        <!-- 执行人 + 初始进度 -->
        <div class="form-row">
            <div class="form-col">
                <input type="hidden" name="executorId" class="modern-input" th:value="${executorId}">
            </div>
            <div class="form-col">
                <label class="modern-label">
                    <i class="fa fa-percent"></i> 初始进度
                </label>
                <select name="progress" class="modern-input form-select">
                    <option value="0" selected>0% (未开始)</option>
                    <option value="25">25% (进行中)</option>
                    <option value="50">50% (过半)</option>
                    <option value="75">75% (接近完成)</option>
                    <option value="100">100% (已完成)</option>
                </select>
            </div>
        </div>

        <!-- 详细描述 -->
        <div class="modern-group">
            <label class="modern-label">
                <i class="fa fa-file-text-o"></i> 详细描述
            </label>
            <textarea name="description" class="modern-input" rows="6" placeholder="支持 Markdown 格式（预留），可填写任务详情、验收标准等..."></textarea>
        </div>

        <!-- 操作按钮 -->
        <div class="btn-footer">
            <button type="button" class="btn-modern" style="border:1px solid #ddd; background:#fff; color:#555; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px;" onclick="closeModal()">取消</button>
            <button type="button" class="btn-submit" onclick="submitHandler()">创建任务</button>
        </div>
    </form>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: datetimepicker-js" />
<script>
    // 基础配置
    var prefix = ctx + "kanban/card";
    var isSubmitting = false; // 防止重复提交
    // 标记是否是任务池新增（boardId和listId都为空）
    var isTaskPoolAdd = [[${boardId == null && listId == null}]];

    // 1. 优先级选择逻辑
    function setPri(el) {
        $('.priority-opt').removeClass('active');
        $(el).addClass('active');
        $(el).find('input[type="radio"]').prop('checked', true);
    }

    // 2. 页面初始化
    $("#boardSelect").change(function(){
        var boardId = $(this).val();
        var $listSelect = $("#listSelect");

        // 清空清单下拉框
        $listSelect.html('<option value="">加载中...</option>').prop('disabled', true);

        if(!boardId){
            $listSelect.html('<option value="">-- 请先选择看板 --</option>').prop('disabled', false);
            return;
        }

        // 【真实接口请求 - 根据看板ID获取清单】
        $.ajax({
            url: prefix + "/getLists", // 后端已实现的接口
            type: "get",
            data: {boardId: boardId}, // 传递看板ID
            success: function(res) {
                $listSelect.prop('disabled', false);
                if (res.code === 0 && res.data && res.data.length > 0) {
                    // 拼接真实清单选项
                    var html = '<option value="">-- 请选择清单 --</option>';
                    $.each(res.data, function(i, list){
                        // 确保listId和listName与后端返回字段一致
                        html += `<option value="${list.listId}">${list.listName}</option>`;
                    });
                    $listSelect.html(html);
                } else {
                    // 无清单时的提示
                    $listSelect.html('<option value="">该看板下暂无清单</option>');
                }
            },
            error: function() {
                $listSelect.prop('disabled', false);
                $listSelect.html('<option value="">加载清单失败，请重试</option>');
            }
        });
    });

    // 3. 纯原生表单校验（替代$.validate）
    function validateForm() {
        var isValid = true;
        // 隐藏所有错误提示
        $('.error-tip').hide();

        // 校验任务标题
        var cardTitle = $('input[name="cardTitle"]').val().trim();
        if(!cardTitle){
            $('#cardTitleTip').show();
            isValid = false;
        } else if(cardTitle.length > 100){
            $('#cardTitleTip').text('任务标题不能超过100个字符').show();
            isValid = false;
        }

        // 只有任务池新增时，才校验看板和清单
        if(isTaskPoolAdd){
            // 校验看板
            var boardId = $('#boardSelect').val();
            if(!boardId){
                $('#boardIdTip').show();
                isValid = false;
            }

            // 校验清单
            var listId = $('#listSelect').val();
            if(!listId){
                $('#listIdTip').show();
                isValid = false;
            }
        }

        return isValid;
    }

    // 4. 提交表单
    function submitHandler() {
        // 防止重复提交
        if (isSubmitting) return;

        // 表单校验（纯原生，无依赖）
        if (!validateForm()) {
            return;
        }

        isSubmitting = true;
        $('.btn-submit').text('提交中...').prop('disabled', true);

        $.ajax({
            url: prefix + "/add",
            type: "post",
            data: $('#form-card-add').serialize(),
            success: function(res) {
                if (res.code === 0) {
                    Swal.fire({
                        icon: 'success',
                        title: '创建成功',
                        text: '任务已成功添加！',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        // 刷新父页面并关闭弹窗
                        if (parent.refreshBoard) {
                            parent.refreshBoard();
                        }
                        closeModal();
                    });
                } else {
                    Swal.fire('提交失败', res.msg || '任务创建失败', 'error');
                }
            },
            error: function() {
                Swal.fire('请求失败', '网络异常，请稍后重试', 'error');
            },
            complete: function() {
                // 恢复提交状态
                isSubmitting = false;
                $('.btn-submit').text('创建任务').prop('disabled', false);
            }
        });
    }

    // 5. 关闭弹窗
    function closeModal() {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }

    // 6. 回车提交
    $(document).keydown(function(e) {
        if (e.keyCode === 13 && !e.ctrlKey && !e.shiftKey) {
            e.preventDefault();
            submitHandler();
        }
    });
</script>
</body>
</html>