<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增任务卡片')" />
    <th:block th:include="include :: datetimepicker-css" />
    <th:block th:include="include :: summernote-css" />
    <style>
        input[type=range] { -webkit-appearance: none; width: 100%; margin: 5px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e9ecef; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #0079bf; cursor: pointer; -webkit-appearance: none; margin-top: -5px; }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-card-add">
        <th:block th:if="${boardId != null}">
            <input name="boardId" type="hidden" th:value="${boardId}" />
            <input name="listId" type="hidden" th:value="${listId}" />
        </th:block>

        <th:block th:if="${boardId == null}">
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">归属看板：</label>
                <div class="col-sm-8">
                    <select name="boardId" class="form-control" onchange="loadLists(this.value)" required>
                        <option value="">-- 请选择看板 --</option>
                        <option th:each="b : ${boards}" th:value="${b.boardId}" th:text="${b.boardName}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label is-required">归属清单：</label>
                <div class="col-sm-8">
                    <select name="listId" id="listSelect" class="form-control" required>
                        <option value="">-- 请先选择看板 --</option>
                    </select>
                </div>
            </div>
        </th:block>

        <div class="form-group">
            <label class="col-sm-3 control-label is-required">任务标题：</label>
            <div class="col-sm-8">
                <input name="cardTitle" class="form-control" type="text" required>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">优先级：</label>
            <div class="col-sm-8">
                <select name="priority" class="form-control" th:with="type=${@dict.getType('kb_card_priority')}">
                    <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:selected="${dict.isDefault == 'Y'}"></option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">任务进度：</label>
            <div class="col-sm-8">
                <div style="display: flex; align-items: center;">
                    <input name="progress" type="range" min="0" max="100" value="0" step="5"
                           style="flex-grow: 1; margin-right: 15px;"
                           oninput="$('#prog-label').text(this.value + '%')">
                    <span id="prog-label" class="badge badge-primary" style="min-width: 45px; font-size: 13px;">0%</span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">截止时间：</label>
            <div class="col-sm-8">
                <div class="input-group date">
                    <input name="deadline" class="form-control" placeholder="yyyy-MM-dd" type="text">
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">任务详情：</label>
            <div class="col-sm-8">
                <input type="hidden" class="form-control" name="cardContent">
                <div class="summernote" id="cardContent"></div>
            </div>
        </div>

        <input name="orderNum" type="hidden" value="0">
    </form>
</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: datetimepicker-js" />
<th:block th:include="include :: summernote-js" />
<script th:inline="javascript">
    var prefix = ctx + "kanban/card"
    $("#form-card-add").validate({ focusCleanup: true });

    function submitHandler() {
        if ($.validate.form()) {
            $.operate.save(prefix + "/add", $('#form-card-add').serialize(), function(result) {
                if (result.code === web_status.SUCCESS) {
                    $.modal.msgSuccess(result.msg);
                    // 尝试刷新父级页面（如果是看板视图）
                    try { parent.refreshBoard(); } catch(e) {}
                    // 尝试刷新表格（如果是任务池列表）
                    try { parent.$.table.refresh(); } catch(e) {}
                    $.modal.close();
                } else {
                    $.modal.alertError(result.msg);
                }
            });
        }
    }

    // 动态加载清单列表
    function loadLists(boardId) {
        $("#listSelect").html('<option value="">加载中...</option>');
        if(!boardId) {
            $("#listSelect").html('<option value="">-- 请先选择看板 --</option>');
            return;
        }
        $.get(prefix + "/getLists?boardId=" + boardId, function(res) {
            var html = '<option value="">-- 请选择清单 --</option>';
            if(res.data && res.data.length > 0) {
                for(var i=0; i<res.data.length; i++) {
                    html += '<option value="' + res.data[i].listId + '">' + res.data[i].listName + '</option>';
                }
            } else {
                html = '<option value="">该看板下没有清单，请先去看板添加</option>';
            }
            $("#listSelect").html(html);
        });
    }

    $("input[name='deadline']").datetimepicker({ format: "yyyy-mm-dd", minView: "month", autoclose: true });

    $(function() {
        $('.summernote').summernote({
            lang: 'zh-CN', height: 150, dialogsInBody: true,
            callbacks: {
                onChange: function(contents) { $("input[name='" + this.id + "']").val(contents); }
            }
        });
    });
</script>
</body>
</html>