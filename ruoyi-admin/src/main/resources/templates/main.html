<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:include="include :: header('工作台')" />
	<style>
		.dashboard-box { padding: 15px; margin-bottom: 20px; background: #fff; border-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,.05); }
		.stat-card { display: flex; align-items: center; padding: 20px; color: #fff; border-radius: 4px; margin-bottom: 15px; cursor: pointer; transition: transform 0.2s; }
		.stat-card:hover { transform: translateY(-3px); }
		.stat-icon { width: 50px; font-size: 32px; opacity: 0.8; }
		.stat-content h3 { margin: 0; font-size: 28px; font-weight: bold; }
		.stat-content p { margin: 0; opacity: 0.9; font-size: 13px; }

		/* 颜色定义 */
		.bg-primary { background-color: #23b7e5; }
		.bg-success { background-color: #27c24c; }
		.bg-warning { background-color: #fad733; color: #fff!important; }
		.bg-danger  { background-color: #f05050; }
		.text-info  { color: #23b7e5; }

		.table-hover tbody tr:hover { background-color: #f8f8f8; }
	</style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content">

	<div class="row">
		<div class="col-sm-3">
			<div class="stat-card bg-primary" onclick="openTab('我的任务', '/kanban/card')">
				<div class="stat-icon"><i class="fa fa-tasks"></i></div>
				<div class="stat-content">
					<h3 id="stat-total">0</h3>
					<p>我的任务总数</p>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="stat-card bg-warning" onclick="openTab('我的任务', '/kanban/card')">
				<div class="stat-icon"><i class="fa fa-clock-o"></i></div>
				<div class="stat-content">
					<h3 id="stat-pending">0</h3>
					<p>待完成任务</p>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="stat-card bg-danger" onclick="openTab('我的任务', '/kanban/card?status=overdue')">
				<div class="stat-icon"><i class="fa fa-exclamation-triangle"></i></div>
				<div class="stat-content">
					<h3 id="stat-overdue">0</h3>
					<p>已超期任务</p>
				</div>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="stat-card bg-success" onclick="openTab('我的任务', '/kanban/card?status=1')">
				<div class="stat-icon"><i class="fa fa-check-circle"></i></div>
				<div class="stat-content">
					<h3 id="stat-done">0</h3>
					<p>已完成任务</p>
				</div>
			</div>
		</div>
	</div>

	<div class="row">

		<div class="col-sm-4">
			<div class="dashboard-box">
				<div class="ibox-title"><h5><i class="fa fa-fire"></i> 重点关注</h5></div>
				<div class="ibox-content" style="padding: 20px 0;">
					<div class="row text-center">
						<div class="col-xs-4" style="border-right: 1px solid #eee;">
							<h2 class="text-danger" id="stat-tomorrow">0</h2>
							<small class="text-muted">明天截止</small>
						</div>
						<div class="col-xs-4" style="border-right: 1px solid #eee; cursor:pointer;" onclick="openTab('看板列表', '/kanban/board')">
							<h2 class="text-info" id="stat-unassigned">0</h2>
							<small class="text-muted">待认领任务</small>
						</div>
						<div class="col-xs-4">
							<h2 class="text-warning" id="stat-unread">0</h2>
							<small class="text-muted">未读消息</small>
						</div>
					</div>
				</div>
			</div>

			<div class="dashboard-box" style="padding: 0;">
				<div class="ibox-content text-center" style="padding: 30px;">
					<button class="btn btn-primary btn-block btn-lg" onclick="openTab('进入看板', '/kanban/board')">
						<i class="fa fa-columns"></i> 进入我的看板
					</button>
				</div>
			</div>
		</div>

		<div class="col-sm-8">
			<div class="dashboard-box">
				<div class="ibox-title" style="border-bottom: 1px solid #eee; padding: 15px;">
					<h5 style="margin:0;"><i class="fa fa-hourglass-half"></i> 未来7天即将到期任务</h5>
				</div>
				<div class="ibox-content">
					<table class="table table-hover" style="margin-bottom: 0;">
						<thead>
						<tr>
							<th>任务标题</th>
							<th width="120">截止时间</th>
							<th width="80">优先级</th>
							<th width="150">进度</th>
							<th width="80">操作</th>
						</tr>
						</thead>
						<tbody id="upcoming-table-body">
						<tr><td colspan="5" class="text-center"><i class="fa fa-spinner fa-spin"></i> 加载中...</td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

<th:block th:include="include :: footer" />
<script>
	$(function(){
		loadStats();
	});

	// 打开新页签的辅助函数
	function openTab(title, url) {
		$.modal.openTab(title, ctx + url.substring(1)); // 去掉开头的/
	}

	// 核心：加载数据
	function loadStats() {
		$.get(ctx + "kanban/main/stats", function(res){
			if(res.code === 0) {
				var data = res.data;
				// 1. 填充数字
				$("#stat-total").text(data.total || 0);
				$("#stat-pending").text(data.pending || 0);
				$("#stat-done").text(data.done || 0);
				$("#stat-overdue").text(data.overdue || 0);
				$("#stat-tomorrow").text(data.tomorrow || 0);
				$("#stat-unassigned").text(data.unassigned || 0);
				$("#stat-unread").text(data.unreadMsg || 0);

				// 2. 填充即将到期列表
				var html = "";
				if(data.upcomingList && data.upcomingList.length > 0) {
					$.each(data.upcomingList, function(i, item){
						// 处理优先级显示样式
						var pMap = {'0': '紧急', '1': '高', '2': '中', '3': '低'};
						var cMap = {'0': 'label-danger', '1': 'label-warning', '2': 'label-info', '3': 'label-default'};
						var pText = pMap[item.priority] || '普通';
						var pClass = cMap[item.priority] || 'label-default';

						var dateStr = item.deadline ? item.deadline.substring(0,10) : '-';
						var progress = item.progress || 0;

						html += '<tr>' +
								'<td>' + item.cardTitle + '</td>' +
								'<td><i class="fa fa-clock-o"></i> ' + dateStr + '</td>' +
								'<td><span class="label ' + pClass + '">' + pText + '</span></td>' +
								'<td>' +
								'<small>' + progress + '%</small>' +
								'<div class="progress progress-mini" style="margin:2px 0;">' +
								'<div style="width: ' + progress + '%;" class="progress-bar"></div>' +
								'</div>' +
								'</td>' +
								'<td><a href="javascript:void(0)" onclick="editCard(\''+item.cardId+'\')" class="btn btn-xs btn-primary">查看</a></td>' +
								'</tr>';
					});
				} else {
					html = '<tr><td colspan="5" class="text-center text-muted" style="padding:20px;">暂无即将到期任务，太棒了！</td></tr>';
				}
				$("#upcoming-table-body").html(html);
			} else {
				$("#upcoming-table-body").html('<tr><td colspan="5" class="text-center text-danger">数据加载失败</td></tr>');
			}
		});
	}

	function editCard(cardId) {
		// 弹出层查看/编辑任务
		$.modal.open("任务详情", ctx + "kanban/card/edit/" + cardId);
	}
</script>
</body>
</html>