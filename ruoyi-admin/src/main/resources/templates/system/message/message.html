<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('我的消息')" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f4f5f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .msg-layout { display: flex; height: 100%; max-width: 1200px; margin: 0 auto; width: 100%; padding: 20px; gap: 20px; }

        /* 左侧侧边栏 */
        .msg-sidebar { width: 240px; background: #fff; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .sidebar-btn {
            padding: 12px 15px; border-radius: 8px; color: #5e6c84; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500;
        }
        .sidebar-btn:hover { background: #ebecf0; color: #172b4d; }
        .sidebar-btn.active { background: #e6f7ff; color: #0079bf; font-weight: 600; }
        .sidebar-btn i { width: 20px; text-align: center; }

        .btn-compose {
            background: #0079bf; color: #fff; text-align: center; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,121,191,0.2);
        }
        .btn-compose:hover { background: #005a8e; transform: translateY(-1px); }

        /* 右侧消息列表 */
        .msg-content { flex: 1; background: #fff; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .msg-header { padding: 15px 25px; border-bottom: 1px solid #ebecf0; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .header-title { font-size: 16px; font-weight: 700; color: #172b4d; }

        .msg-list-container { flex: 1; overflow-y: auto; padding: 0; }
        .msg-list-container::-webkit-scrollbar { width: 6px; }
        .msg-list-container::-webkit-scrollbar-thumb { background: #dfe1e6; border-radius: 3px; }

        .msg-item {
            padding: 20px 25px; border-bottom: 1px solid #f4f5f7; cursor: pointer; transition: background 0.1s; position: relative;
        }
        .msg-item:hover { background: #fafbfc; }
        .msg-item.unread { background: #fff; }
        .msg-item.unread::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #0079bf;
        }

        .msg-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .msg-title { font-size: 15px; font-weight: 600; color: #172b4d; display: flex; align-items: center; gap: 8px; }
        .unread-dot { width: 8px; height: 8px; background: #0079bf; border-radius: 50%; display: inline-block; }

        .msg-time { font-size: 12px; color: #97a0af; }
        .msg-body { font-size: 14px; color: #5e6c84; line-height: 1.5; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .empty-state { text-align: center; padding: 60px; color: #97a0af; }

        /* 标签 */
        .type-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #ebecf0; color: #5e6c84; font-weight: normal; }
        .type-badge.system { background: #deebff; color: #0747a6; }
    </style>
</head>
<body class="gray-bg">

<div class="msg-layout">
    <div class="msg-sidebar">
        <div class="btn-compose" onclick="openPublishModal()" shiro:hasPermission="system:message:publish">
            <i class="fa fa-pencil"></i> 发布通知
        </div>

        <div class="sidebar-btn active" onclick="loadMessages()">
            <i class="fa fa-inbox"></i> 收件箱
        </div>
        <div class="sidebar-btn" style="cursor: default; opacity: 0.6;">
            <i class="fa fa-paper-plane"></i> 已发送 (开发中)
        </div>
    </div>

    <div class="msg-content">
        <div class="msg-header">
            <div class="header-title">消息列表</div>
            <button class="btn btn-default btn-xs" onclick="markAllRead()"><i class="fa fa-check-circle-o"></i> 全部已读</button>
        </div>
        <div class="msg-list-container" id="msgList">
        </div>
    </div>
</div>

<div id="publishModal" style="display:none; padding:20px;">
    <form id="form-publish" class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-3 control-label">通知标题：</label>
            <div class="col-sm-9">
                <input type="text" name="title" class="form-control" placeholder="请输入标题" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">消息类型：</label>
            <div class="col-sm-9">
                <select name="type" class="form-control">
                    <option value="通知">系统通知</option>
                    <option value="公告">团队公告</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">接收范围：</label>
            <div class="col-sm-9">
                <select name="scope" class="form-control" onchange="toggleUserSelect(this.value)">
                    <option value="all">全员广播</option>
                    <option value="specified">指定成员</option>
                </select>
            </div>
        </div>
        <div class="form-group" id="userSelectGroup" style="display:none;">
            <label class="col-sm-3 control-label">选择成员：</label>
            <div class="col-sm-9">
                <input type="text" name="receiveUserIds" class="form-control" placeholder="请输入用户ID，逗号分隔 (例: 1,2,3)">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">内容详情：</label>
            <div class="col-sm-9">
                <textarea name="content" class="form-control" rows="4" required></textarea>
            </div>
        </div>
    </form>
</div>

<th:block th:include="include :: footer" />
<script>
    var prefix = ctx + "system/message";

    $(function() {
        loadMessages();
    });

    // 1. 加载消息列表
    function loadMessages() {
        $.post(prefix + "/list", {}, function(res) {
            var rows = res.rows;
            var html = '';
            if (!rows || rows.length === 0) {
                html = '<div class="empty-state"><i class="fa fa-envelope-o fa-3x"></i><br>暂无消息</div>';
            } else {
                html = rows.map(function(item) {
                    var isRead = item.isRead === '1';
                    var readClass = isRead ? '' : 'unread';
                    var dot = isRead ? '' : '<span class="unread-dot"></span>';

                    return `
                    <div class="msg-item ${readClass}" onclick="readMessage(${item.messageId}, this)">
                        <div class="msg-top">
                            <div class="msg-title">
                                ${dot} <span class="type-badge system">${item.type || '通知'}</span> ${item.title}
                            </div>
                            <div class="msg-time">${item.createTime}</div>
                        </div>
                        <div class="msg-body">${item.content}</div>
                    </div>
                    `;
                }).join('');
            }
            $("#msgList").html(html);
        });
    }

    // 2. 点击阅读
    function readMessage(id, el) {
        // 视觉上立即变已读
        $(el).removeClass('unread').find('.unread-dot').remove();

        // 发送后端
        $.post(prefix + "/read", { messageId: id });

        // 弹窗显示详情
        var content = $(el).find('.msg-body').text();
        var title = $(el).find('.msg-title').text().trim();
        Swal.fire({
            title: title,
            text: content,
            confirmButtonText: '关闭',
            confirmButtonColor: '#0079bf'
        });
    }

    // 3. 全部已读
    function markAllRead() {
        $.post(prefix + "/readAll", function(res) {
            if (res.code === 0) {
                Swal.fire({ icon: 'success', title: '操作成功', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false });
                loadMessages();
            }
        });
    }

    // 4. 打开发布窗口
    function openPublishModal() {
        layer.open({
            type: 1,
            title: '发布新通知',
            area: ['600px', '450px'],
            content: $('#publishModal'),
            btn: ['立即发送', '取消'],
            yes: function(index, layero) {
                $.ajax({
                    url: prefix + "/publish",
                    type: "post",
                    data: $('#form-publish').serialize(),
                    success: function(res) {
                        if (res.code === 0) {
                            layer.close(index);
                            Swal.fire('发送成功', res.msg, 'success');
                            loadMessages();
                        } else {
                            Swal.fire('发送失败', res.msg, 'error');
                        }
                    }
                });
            }
        });
    }

    function toggleUserSelect(val) {
        if(val === 'specified') $('#userSelectGroup').show();
        else $('#userSelectGroup').hide();
    }
</script>
</body>
</html>